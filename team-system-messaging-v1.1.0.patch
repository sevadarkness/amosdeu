From 582f771ad796eb2adf06fc1b5943fdc3fd674ae9 Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Sun, 4 Jan 2026 20:13:38 +0000
Subject: [PATCH] =?UTF-8?q?=E2=9C=A8=20Team=20System:=20Adicionar=20dispar?=
 =?UTF-8?q?o=20de=20mensagens=20com=20WhatsApp=20API?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

FUNCIONALIDADES IMPLEMENTADAS:
‚úÖ openChatByPhone() - Abre chat usando Store.Cmd.openChatAt + fallbacks
‚úÖ sendMessageToChat() - Envia mensagem com HumanTyping integrado
‚úÖ sendToPhone() - Abre chat + envia mensagem (fluxo completo)
‚úÖ broadcastToTeam() - Envia para m√∫ltiplos membros com delay

M√âTODOS DE ABERTURA DE CHAT:
1. Store.Cmd.openChatAt() - M√©todo principal
2. Store.Chat.find() + chat.open() - Fallback 1
3. URL (web.whatsapp.com/send) - Fallback 2

M√âTODOS DE ENVIO:
1. window.HumanTyping.type() - Digita√ß√£o humanizada
2. document.execCommand('insertText') - Fallback manual
3. M√∫ltiplos seletores de input field

BASEADO EM:
- smartbot-autopilot-v2.js (m√©todos de chat)
- crm.js (abertura de conversas)
- recover-advanced.js (Store API usage)

ESTAT√çSTICAS:
- Arquivo: 638 ‚Üí 939 linhas (+301)
- Vers√£o: 1.0.0 ‚Üí 1.1.0
- 4 novas fun√ß√µes p√∫blicas na API

BROADCAST FEATURES:
- Delay configur√°vel entre envios (3-7s padr√£o)
- Assinatura autom√°tica do remetente
- Rastreamento de sucesso/falha
- Atualiza√ß√£o autom√°tica de estat√≠sticas
- Evento 'teamsystem:broadcast_completed'
---
 whatshybrid-extension/modules/team-system.js | 303 ++++++++++++++++++-
 1 file changed, 302 insertions(+), 1 deletion(-)

diff --git a/whatshybrid-extension/modules/team-system.js b/whatshybrid-extension/modules/team-system.js
index b5251a5..536a2e0 100644
--- a/whatshybrid-extension/modules/team-system.js
+++ b/whatshybrid-extension/modules/team-system.js
@@ -10,8 +10,12 @@
  * - Transfer√™ncia de atendimento
  * - Estat√≠sticas por membro
  * - Notas internas
+ * - ‚úÖ Disparo de mensagens via WhatsApp API (Store.Cmd, Store.Chat)
+ * - ‚úÖ Broadcast para m√∫ltiplos membros
+ * - ‚úÖ Integra√ß√£o com HumanTyping para digita√ß√£o natural
+ * - ‚úÖ M√∫ltiplos fallbacks de envio
  *
- * @version 1.0.0
+ * @version 1.1.0
  */
 
 (function() {
@@ -369,6 +373,284 @@
     return true;
   }
 
+  // ============================================================
+  // DISPARO DE MENSAGENS (WhatsApp API Integration)
+  // ============================================================
+
+  function sleep(ms) {
+    return new Promise(resolve => setTimeout(resolve, ms));
+  }
+
+  /**
+   * Abre chat usando API interna do WhatsApp
+   * M√©todos baseados em smartbot-autopilot-v2.js e crm.js
+   */
+  async function openChatByPhone(phone) {
+    const cleanPhone = phone.replace(/\D/g, '');
+
+    // M√©todo 1: Via Store.Cmd.openChatAt (mais confi√°vel)
+    if (window.Store?.Cmd?.openChatAt) {
+      try {
+        await window.Store.Cmd.openChatAt(cleanPhone + '@c.us');
+        console.log('[TeamSystem] ‚úÖ Chat aberto via Store.Cmd.openChatAt');
+        await sleep(1500);
+        return true;
+      } catch (e) {
+        console.warn('[TeamSystem] Store.Cmd.openChatAt falhou:', e.message);
+      }
+    }
+
+    // M√©todo 2: Via Store.Chat.find
+    if (window.Store?.Chat?.find) {
+      try {
+        const chat = await window.Store.Chat.find(cleanPhone + '@c.us');
+        if (chat) {
+          if (chat.open) {
+            await chat.open();
+          } else if (window.Store?.Cmd?.openChatFromContact) {
+            await window.Store.Cmd.openChatFromContact(chat);
+          }
+          console.log('[TeamSystem] ‚úÖ Chat aberto via Store.Chat.find');
+          await sleep(1500);
+          return true;
+        }
+      } catch (e) {
+        console.warn('[TeamSystem] Store.Chat.find falhou:', e.message);
+      }
+    }
+
+    // M√©todo 3: Via URL (fallback)
+    try {
+      const link = document.createElement('a');
+      link.href = `https://web.whatsapp.com/send?phone=${cleanPhone}`;
+      link.click();
+      console.log('[TeamSystem] ‚ö†Ô∏è Chat aberto via URL fallback');
+      await sleep(3000);
+      return true;
+    } catch (e) {
+      console.error('[TeamSystem] Todos os m√©todos de abertura falharam:', e);
+    }
+
+    return false;
+  }
+
+  /**
+   * Envia mensagem no chat atual usando HumanTyping
+   * M√©todo baseado em smartbot-autopilot-v2.js
+   */
+  async function sendMessageToChat(text) {
+    // Encontrar campo de input
+    const inputSelectors = [
+      'footer div[contenteditable="true"][role="textbox"]',
+      '[data-testid="conversation-compose-box-input"]',
+      'div[contenteditable="true"][role="textbox"]'
+    ];
+
+    let inputField = null;
+    for (const sel of inputSelectors) {
+      inputField = document.querySelector(sel);
+      if (inputField) {
+        console.log('[TeamSystem] Campo de input encontrado:', sel);
+        break;
+      }
+    }
+
+    if (!inputField) {
+      console.error('[TeamSystem] ‚ùå Campo de input n√£o encontrado');
+      return false;
+    }
+
+    // Focar no campo
+    inputField.focus();
+    await sleep(200);
+
+    // Limpar campo
+    inputField.textContent = '';
+    inputField.innerHTML = '';
+
+    // Usar HumanTyping se dispon√≠vel
+    if (window.HumanTyping?.type) {
+      try {
+        await window.HumanTyping.type(inputField, text, {
+          minDelay: 30,
+          maxDelay: 80
+        });
+        console.log('[TeamSystem] ‚úÖ Texto digitado com HumanTyping');
+      } catch (e) {
+        console.warn('[TeamSystem] HumanTyping falhou, usando fallback');
+        // Fallback: inser√ß√£o direta
+        for (const char of text) {
+          document.execCommand('insertText', false, char);
+          inputField.dispatchEvent(new Event('input', { bubbles: true }));
+          await sleep(Math.random() * 40 + 20);
+        }
+      }
+    } else {
+      // Fallback: digita√ß√£o manual
+      console.log('[TeamSystem] HumanTyping n√£o dispon√≠vel, usando digita√ß√£o manual');
+      for (const char of text) {
+        document.execCommand('insertText', false, char);
+        inputField.dispatchEvent(new Event('input', { bubbles: true }));
+        await sleep(Math.random() * 40 + 20);
+      }
+    }
+
+    await sleep(300);
+
+    // Clicar no bot√£o enviar
+    const sendBtn = document.querySelector('[data-testid="send"]') ||
+                    document.querySelector('button[aria-label*="Enviar"]') ||
+                    document.querySelector('span[data-icon="send"]')?.parentElement;
+
+    if (sendBtn) {
+      sendBtn.click();
+      console.log('[TeamSystem] ‚úÖ Mensagem enviada via bot√£o');
+      await sleep(500);
+      return true;
+    }
+
+    // Fallback: pressionar Enter
+    inputField.dispatchEvent(new KeyboardEvent('keydown', {
+      key: 'Enter',
+      keyCode: 13,
+      bubbles: true
+    }));
+    console.log('[TeamSystem] ‚úÖ Mensagem enviada via Enter');
+    await sleep(500);
+    return true;
+  }
+
+  /**
+   * Envia mensagem para um telefone espec√≠fico
+   * (abre chat + envia mensagem)
+   */
+  async function sendToPhone(phone, message) {
+    try {
+      const opened = await openChatByPhone(phone);
+      if (!opened) {
+        throw new Error('N√£o foi poss√≠vel abrir o chat');
+      }
+
+      const sent = await sendMessageToChat(message);
+      if (!sent) {
+        throw new Error('N√£o foi poss√≠vel enviar a mensagem');
+      }
+
+      return { success: true, phone, message };
+    } catch (error) {
+      console.error('[TeamSystem] Erro ao enviar para', phone, ':', error);
+      return { success: false, phone, error: error.message };
+    }
+  }
+
+  /**
+   * Broadcast: envia mensagem para m√∫ltiplos membros da equipe
+   * @param {Array<string>} memberIds - IDs dos membros que receber√£o a mensagem
+   * @param {string} message - Mensagem a ser enviada
+   * @param {Object} options - Op√ß√µes de envio
+   * @returns {Object} Resultado do broadcast
+   */
+  async function broadcastToTeam(memberIds, message, options = {}) {
+    const {
+      delayMin = 3000,
+      delayMax = 7000,
+      includeSignature = true,
+      senderName = state.currentUser?.name || 'Equipe'
+    } = options;
+
+    const results = {
+      total: memberIds.length,
+      success: 0,
+      failed: 0,
+      details: []
+    };
+
+    // Validar membros
+    const members = memberIds.map(id => state.members.find(m => m.id === id)).filter(Boolean);
+
+    if (members.length === 0) {
+      console.warn('[TeamSystem] Nenhum membro v√°lido para broadcast');
+      return results;
+    }
+
+    // Formatar mensagem com assinatura
+    const fullMessage = includeSignature
+      ? `*${senderName}:* ${message}`
+      : message;
+
+    console.log(`[TeamSystem] üì¢ Iniciando broadcast para ${members.length} membros...`);
+
+    for (let i = 0; i < members.length; i++) {
+      const member = members[i];
+
+      // Pular se o membro n√£o tiver telefone/email configurado
+      // (assumindo que email pode conter telefone ou ID do WhatsApp)
+      if (!member.email || !member.email.match(/\d+/)) {
+        console.warn('[TeamSystem] Membro sem telefone:', member.name);
+        results.failed++;
+        results.details.push({
+          member: member.name,
+          status: 'failed',
+          error: 'Telefone n√£o configurado'
+        });
+        continue;
+      }
+
+      try {
+        // Extrair telefone do email (se for n√∫mero)
+        const phone = member.email.replace(/\D/g, '');
+
+        console.log(`[TeamSystem] [${i + 1}/${members.length}] Enviando para ${member.name}...`);
+
+        const result = await sendToPhone(phone, fullMessage);
+
+        if (result.success) {
+          results.success++;
+          results.details.push({
+            member: member.name,
+            status: 'success'
+          });
+
+          // Atualizar estat√≠sticas do membro
+          if (!member.stats) {
+            member.stats = { chatsHandled: 0, messagesSent: 0, avgResponseTime: 0, satisfaction: 0 };
+          }
+          member.stats.messagesSent++;
+        } else {
+          throw new Error(result.error);
+        }
+
+        // Delay entre envios (exceto no √∫ltimo)
+        if (i < members.length - 1) {
+          const delay = Math.random() * (delayMax - delayMin) + delayMin;
+          console.log(`[TeamSystem] Aguardando ${Math.round(delay / 1000)}s antes do pr√≥ximo envio...`);
+          await sleep(delay);
+        }
+
+      } catch (error) {
+        results.failed++;
+        results.details.push({
+          member: member.name,
+          status: 'failed',
+          error: error.message
+        });
+        console.error('[TeamSystem] Erro ao enviar para', member.name, ':', error);
+      }
+    }
+
+    // Salvar estat√≠sticas atualizadas
+    await saveState();
+
+    console.log('[TeamSystem] üì¢ Broadcast conclu√≠do:', results);
+
+    // Emitir evento
+    if (window.EventBus) {
+      window.EventBus.emit('teamsystem:broadcast_completed', results);
+    }
+
+    return results;
+  }
+
   // ============================================================
   // ESTAT√çSTICAS
   // ============================================================
@@ -605,7 +887,10 @@
   // ============================================================
 
   window.TeamSystem = {
+    // Inicializa√ß√£o
     init,
+
+    // Gerenciamento de usu√°rios
     setCurrentUser,
     getCurrentUser: () => state.currentUser,
     getMembers: () => [...state.members],
@@ -613,17 +898,33 @@
     removeMember,
     updateMemberStatus,
     updateMemberRole,
+
+    // Atribui√ß√£o de conversas
     assignChat,
     unassignChat,
     getAssignedUser,
     getUserChats,
     transferChat,
+
+    // Notas internas
     addNote,
     getNotes,
     deleteNote,
+
+    // Disparo de mensagens (NEW!)
+    openChatByPhone,
+    sendMessageToChat,
+    sendToPhone,
+    broadcastToTeam,
+
+    // Estat√≠sticas
     getTeamStats,
     getMemberStats,
+
+    // UI
     renderTeamPanel,
+
+    // Constantes
     ROLES,
     STATUSES
   };
-- 
2.43.0

